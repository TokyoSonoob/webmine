<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register/Login â†’ à¸«à¹‰à¸­à¸‡à¸„à¸¸à¸¢à¹€à¸ªà¸µà¸¢à¸‡ (WebRTC + Firebase)</title>
  <meta name="theme-color" content="#7c3aed" />
  <style>
    :root{--bg:#0b0f17;--panel:#0f1522;--panel2:#0b1220;--ink:#e9ecff;--muted:#98a2d7;--acc:#7c3aed;--ok:#22c55e;--err:#ef4444;--bd:1px solid #1b2540;--rad:16px}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:980px;margin-inline:auto;padding:24px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#a78bfa,#7c3aed);box-shadow:0 8px 30px rgba(124,58,237,.35)}
    h1{font-size:22px;margin:0;background:linear-gradient(90deg,#fff,#a78bfa);-webkit-background-clip:text;background-clip:text;color:transparent}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:var(--bd);border-radius:var(--rad);padding:18px;margin-bottom:14px;box-shadow:0 8px 28px rgba(7,13,25,.45) inset,0 6px 30px rgba(124,58,237,.08)}
    .row{display:flex;flex-wrap:wrap;gap:12px} .grow{flex:1 1 260px}
    button{appearance:none;border:none;cursor:pointer;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;padding:12px 16px;border-radius:12px;font-weight:700;box-shadow:0 8px 24px rgba(124,58,237,.35);transition:transform .08s ease,opacity .2s}
    button.secondary{background:#1b2641} button.ghost{background:transparent;border:var(--bd);color:var(--ink)} button:active{transform:translateY(1px)}
    input{width:100%;background:#0c1322;color:var(--ink);border:var(--bd);padding:12px 14px;border-radius:12px;outline:none}
    label{display:block;margin:8px 2px;color:var(--muted)} .muted{color:var(--muted)} .tag{display:inline-flex;align-items:center;gap:8px;background:#0d1730;border:var(--bd);border-radius:999px;padding:8px 12px}
    .bigcode{font-size:28px;font-weight:800;letter-spacing:.12em}
    .status{white-space:pre-wrap;background:#0e162b;border:var(--bd);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,Monaco;min-height:64px}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>à¸ªà¸¡à¸±à¸„à¸£/à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š â†’ à¸ªà¸£à¹‰à¸²à¸‡/à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡ â†’ à¸„à¸¸à¸¢à¹€à¸ªà¸µà¸¢à¸‡</h1>
    </header>

    <!-- REGISTER -->
    <section id="registerCard" class="card">
      <h3>à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸</h3>
      <label>à¸­à¸µà¹€à¸¡à¸¥</label>
      <input id="regEmail" type="email" placeholder="you@example.com" />
      <label>à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</label>
      <input id="regPass" type="password" placeholder="à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£" />
      <label>à¸Šà¸·à¹ˆà¸­ Xbox</label>
      <input id="regXbox" placeholder="à¹€à¸Šà¹ˆà¸™ SeaMuww" />
      <div class="row"><button id="btnRegister">à¸ªà¸¡à¸±à¸„à¸£</button><button id="toLogin" class="ghost">à¸¡à¸µà¸šà¸±à¸à¸Šà¸µà¹à¸¥à¹‰à¸§? à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button></div>
    </section>

    <!-- LOGIN -->
    <section id="loginCard" class="card hidden">
      <h3>à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</h3>
      <label>à¸­à¸µà¹€à¸¡à¸¥</label>
      <input id="logEmail" type="email" />
      <label>à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</label>
      <input id="logPass" type="password" />
      <div class="row"><button id="btnLogin">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button><button id="toRegister" class="ghost">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸šà¸±à¸à¸Šà¸µ? à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸</button></div>
    </section>

    <!-- LOBBY -->
    <section id="lobbyCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="tag">à¸ªà¸§à¸±à¸ªà¸”à¸µ <strong id="helloName">â€”</strong></div>
        <button id="btnLogout" class="ghost">à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸š</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="grow">
          <h3>à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ</h3>
          <button id="btnCreate">à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²</button>
          <div id="createdBox" class="hidden" style="margin-top:10px">
            <div class="muted">à¹à¸Šà¸£à¹Œà¸£à¸«à¸±à¸ªà¸™à¸µà¹‰à¹ƒà¸«à¹‰à¹€à¸à¸·à¹ˆà¸­à¸™</div>
            <div class="bigcode" id="roomCode">â€” â€” â€” â€”</div>
            <button id="btnCopy" class="ghost">à¸„à¸±à¸”à¸¥à¸­à¸à¸£à¸«à¸±à¸ª</button>
          </div>
        </div>
        <div class="grow">
          <h3>à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§</h3>
          <label>à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡ (6 à¸«à¸¥à¸±à¸)</label>
          <input id="joinCode" maxlength="6" inputmode="numeric" placeholder="493120" />
          <button id="btnJoin" class="secondary">à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡</button>
        </div>
      </div>
    </section>

    <!-- IN-ROOM -->
    <section id="roomCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="tag">à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡: <strong id="roomLabel">â€”</strong></div>
        <div class="row">
          <button id="btnToggleMic">ğŸ™ï¸ à¹€à¸›à¸´à¸”à¹„à¸¡à¸„à¹Œ</button>
          <button id="btnLeave" class="ghost">à¸­à¸­à¸à¸ˆà¸²à¸à¸«à¹‰à¸­à¸‡</button>
        </div>
      </div>
      <div class="muted">à¸ªà¸–à¸²à¸™à¸°</div>
      <div id="status" class="status">à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™â€¦</div>
      <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>
    </section>

  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js">// ===== UI ELEMENTS =====
const registerCard = document.querySelector('#registerCard');
const loginCard    = document.querySelector('#loginCard');
const lobbyCard    = document.querySelector('#lobbyCard');
const roomCard     = document.querySelector('#roomCard');
const createdBox   = document.querySelector('#createdBox');

const helloName    = document.querySelector('#helloName');
const btnRegister  = document.querySelector('#btnRegister');
const btnLogin     = document.querySelector('#btnLogin');
const btnLogout    = document.querySelector('#btnLogout');
const toLogin      = document.querySelector('#toLogin');
const toRegister   = document.querySelector('#toRegister');

const btnCreate    = document.querySelector('#btnCreate');
const btnJoin      = document.querySelector('#btnJoin');
const btnCopy      = document.querySelector('#btnCopy');
const joinCode     = document.querySelector('#joinCode');

const roomLabel    = document.querySelector('#roomLabel');
const roomCodeEl   = document.querySelector('#roomCode');
const btnLeave     = document.querySelector('#btnLeave');

// ===== AUTH UI =====

toLogin.onclick = ()=>{ show(registerCard,false); show(loginCard,true); };

toRegister.onclick = ()=>{ show(loginCard,false); show(registerCard,true); };

btnRegister.onclick = async ()=>{
  const email = document.querySelector('#regEmail').value.trim();
  const pass  = document.querySelector('#regPass').value.trim();
  const xbox  = document.querySelector('#regXbox').value.trim();
  if(!email||!pass||!xbox) return alert('à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: xbox });
    await db.collection('users').doc(cred.user.uid).set({ email, xbox, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    alert('à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¹ƒà¸«à¹‰à¹à¸¥à¹‰à¸§');
  }catch(e){ alert(e.message); }
};

btnLogin.onclick = async ()=>{
  const email = document.querySelector('#logEmail').value.trim();
  const pass  = document.querySelector('#logPass').value.trim();
  if(!email||!pass) return alert('à¸à¸£à¸­à¸à¸­à¸µà¹€à¸¡à¸¥à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™');
  try{ await auth.signInWithEmailAndPassword(email, pass); }catch(e){ alert(e.message); }
};

btnLogout.onclick = ()=> auth.signOut();

auth.onAuthStateChanged((user)=>{
  if(user){
    helloName.textContent = user.displayName || user.email;
    show(registerCard,false); show(loginCard,false); show(lobbyCard,true); show(roomCard,false);
  }else{
    show(lobbyCard,false); show(roomCard,false); show(loginCard,true); show(registerCard,false);
  }
});

// ===== UTILS =====
const randRoomCode = ()=> (Math.floor(100000+Math.random()*900000)).toString();

// ===== ROOM LOGIC =====
async function createRoomAndJoin(){
  try{
    const code = randRoomCode();
    roomRef = db.collection('rooms').doc(code);

    createdByMe = true;
    roomLabel.textContent = code;
    roomCodeEl.textContent = code;
    show(createdBox,true);

    await createPeer(true);

    const callerCandidates = roomRef.collection('callerCandidates');
    pc.onicecandidate = (e)=>{ if(e.candidate) callerCandidates.add(e.candidate.toJSON()); };

    const offer = await pc.createOffer({ offerToReceiveAudio: 1 });
    await pc.setLocalDescription(offer);

    const profile = { uid:auth.currentUser.uid, name:auth.currentUser.displayName||auth.currentUser.email };

    await roomRef.set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: { ...profile, joinedAt: firebase.firestore.FieldValue.serverTimestamp() },
      offer: { type: offer.type, sdp: offer.sdp },
      members: [ profile ],
      lastJoin: { [profile.uid]: firebase.firestore.FieldValue.serverTimestamp() }
    });

    unsubAnswer = roomRef.onSnapshot(async (snap)=>{
      const data = snap.data();
      if(!pc.currentRemoteDescription && data && data.answer){
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        log('âœ… à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹à¸¥à¹‰à¸§ (answer)');
      }
    });

    unsubCallee = roomRef.collection('calleeCandidates').onSnapshot((snap)=>{
      snap.docChanges().forEach((c)=>{ if(c.type==='added'){ pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); } });
    });

    show(lobbyCard,false); show(roomCard,true); log('ğŸ‰ à¸«à¹‰à¸­à¸‡ '+code+' à¸–à¸¹à¸à¸ªà¸£à¹‰à¸²à¸‡à¹à¸¥à¹‰à¸§à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´');
  }catch(err){ console.error(err); alert('à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: '+(err.message||err)); }
}

async function joinRoomByCode(){
  try{
    const code = (joinCode.value||'').trim(); if(code.length!==6) return alert('à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ª 6 à¸«à¸¥à¸±à¸');
    roomRef = db.collection('rooms').doc(code); const snap = await roomRef.get(); if(!snap.exists) return alert('à¹„à¸¡à¹ˆà¸à¸šà¸«à¹‰à¸­à¸‡');

    roomLabel.textContent = code; show(lobbyCard,false); show(roomCard,true);

    await createPeer(false);

    const calleeCandidates = roomRef.collection('calleeCandidates');
    pc.onicecandidate = (e)=>{ if(e.candidate) calleeCandidates.add(e.candidate.toJSON()); };

    const data = snap.data();
    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    const profile = { uid:auth.currentUser.uid, name:auth.currentUser.displayName||auth.currentUser.email };

    await roomRef.update({
      answer: { type: answer.type, sdp: answer.sdp },
      members: firebase.firestore.FieldValue.arrayUnion(profile),
      ["lastJoin."+profile.uid]: firebase.firestore.FieldValue.serverTimestamp()
    });

    unsubCaller = roomRef.collection('callerCandidates').onSnapshot((snap)=>{
      snap.docChanges().forEach((c)=>{ if(c.type==='added'){ pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); } });
    });

  }catch(err){ console.error(err); alert('à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: '+(err.message||err)); }
}

async function leaveRoom(){
  try{
    setMic(false);
    if(pc){ pc.getSenders().forEach(s=>{ try{s.track&&s.track.stop();}catch{} }); pc.close(); }
    pc=null; if(unsubAnswer)unsubAnswer(); if(unsubCaller)unsubCaller(); if(unsubCallee)unsubCallee(); unsubAnswer=unsubCaller=unsubCallee=null;
    if(createdByMe && roomRef){ try{ await roomRef.delete(); }catch{} }
  } finally { show(roomCard,false); show(lobbyCard,true); log('ğŸ‘‹ à¸­à¸­à¸à¸ˆà¸²à¸à¸«à¹‰à¸­à¸‡à¹à¸¥à¹‰à¸§'); }
}

// ===== WIRE BUTTONS =====
btnCreate.onclick = createRoomAndJoin;
btnJoin.onclick   = joinRoomByCode;
btnCopy.onclick   = ()=> navigator.clipboard?.writeText(roomCodeEl.textContent).catch(()=>{});
btnLeave.onclick  = leaveRoom;
</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  const firebaseConfig = {
  apiKey: "AIzaSyBswfpiFSZaeHaEKT0RQcsTJMlgdqN8j2A",
  authDomain: "webxxx-c2c15.firebaseapp.com",
  databaseURL: "https://webxxx-c2c15-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webxxx-c2c15",
  storageBucket: "webxxx-c2c15.appspot.com",
  messagingSenderId: "1067079003521",
  appId: "1:1067079003521:web:a3869d6f857e49fb490c80",
  measurementId: "G-7VGKRTCCSF"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  db.enableNetwork().catch(()=>{});

  const $ = (s)=>document.querySelector(s);
  const show=(el,on=true)=>el.classList.toggle('hidden',!on);
  const log=(m)=>{const box=$('#status'); if(box){box.textContent+="\n"+m; box.scrollTop=box.scrollHeight;} console.log(m)};

  let pc=null, localStream=null, remoteStream=null, roomRef=null;
  let unsubAnswer=null,unsubCaller=null,unsubCallee=null;
  let createdByMe=false, micOn=false;
  let audioSender=null;

  const rtcConfig = { iceServers:[{ urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }], iceCandidatePoolSize:10 };

  async function ensureMic(){
    if(!localStream){localStream=await navigator.mediaDevices.getUserMedia({audio:true});}
    return localStream;
  }

  async function createPeer(capture=false){
    pc=new RTCPeerConnection(rtcConfig);
    remoteStream=new MediaStream();
    $('#remoteAudio').srcObject=remoteStream;

    pc.ontrack=(ev)=>{
      ev.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));
      $('#remoteAudio').classList.remove('hidden');
      $('#remoteAudio').play?.().catch(()=>{});
    };
    pc.onconnectionstatechange=()=> log('à¸ªà¸–à¸²à¸™à¸°: '+pc.connectionState);

    // à¹ƒà¸Šà¹‰ transceiver sendrecv à¸ªà¸³à¸«à¸£à¸±à¸š audio
    const trans=pc.addTransceiver('audio',{direction:'sendrecv'});
    audioSender=trans.sender;

    if(capture){
      const s=await ensureMic();
      const track=s.getAudioTracks()[0];
      track.enabled=false;
      await audioSender.replaceTrack(track);
    } else {
      await audioSender.replaceTrack(null);
    }
  }

  function setMic(on){if(!localStream) return;localStream.getAudioTracks().forEach(t=>t.enabled=on);micOn=on;$('#btnToggleMic').textContent=on?'ğŸ”‡ à¸›à¸´à¸”à¹„à¸¡à¸„à¹Œ':'ğŸ™ï¸ à¹€à¸›à¸´à¸”à¹„à¸¡à¸„à¹Œ';}

  $('#btnToggleMic').onclick=async()=>{
    try{
      if(!localStream){localStream=await ensureMic();}
      const track=localStream.getAudioTracks()[0];
      if(!micOn){
        await audioSender?.replaceTrack(track);
        track.enabled=true;
        setMic(true);
      }else{
        track.enabled=false;
        await audioSender?.replaceTrack(track);
        setMic(false);
      }
    }catch(e){alert('à¹€à¸›à¸´à¸”à¹„à¸¡à¸„à¹Œà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: '+(e.message||e));}
  };

  // TODO: implement createRoomAndJoin, joinRoomByCode, leaveRoom
  </script>
</body>
</html>
