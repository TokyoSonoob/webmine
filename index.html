<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register/Login ‚Üí ‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á (WebRTC + Firebase)</title>
  <meta name="theme-color" content="#7c3aed" />
  <style>
    :root{--bg:#0b0f17;--panel:#0f1522;--panel2:#0b1220;--ink:#e9ecff;--muted:#98a2d7;--acc:#7c3aed;--ok:#22c55e;--err:#ef4444;--bd:1px solid #1b2540;--rad:16px}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:980px;margin-inline:auto;padding:24px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#a78bfa,#7c3aed);box-shadow:0 8px 30px rgba(124,58,237,.35)}
    h1{font-size:22px;margin:0;background:linear-gradient(90deg,#fff,#a78bfa);-webkit-background-clip:text;background-clip:text;color:transparent}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:var(--bd);border-radius:var(--rad);padding:18px;margin-bottom:14px;box-shadow:0 8px 28px rgba(7,13,25,.45) inset,0 6px 30px rgba(124,58,237,.08)}
    .row{display:flex;flex-wrap:wrap;gap:12px} .grow{flex:1 1 260px}
    button{appearance:none;border:none;cursor:pointer;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;padding:12px 16px;border-radius:12px;font-weight:700;box-shadow:0 8px 24px rgba(124,58,237,.35);transition:transform .08s ease,opacity .2s}
    button.secondary{background:#1b2641} button.ghost{background:transparent;border:var(--bd);color:var(--ink)} button:active{transform:translateY(1px)}
    input{width:100%;background:#0c1322;color:var(--ink);border:var(--bd);padding:12px 14px;border-radius:12px;outline:none}
    label{display:block;margin:8px 2px;color:var(--muted)} .muted{color:var(--muted)} .tag{display:inline-flex;align-items:center;gap:8px;background:#0d1730;border:var(--bd);border-radius:999px;padding:8px 12px}
    .bigcode{font-size:28px;font-weight:800;letter-spacing:.12em}
    .status{white-space:pre-wrap;background:#0e162b;border:var(--bd);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,Monaco;min-height:64px}
    .hidden{display:none !important}
    /* ‚ú® effect */
    .shine{position:relative;overflow:hidden}
    .shine::after{content:"";position:absolute;inset:-150% -30%;background:linear-gradient(120deg,transparent,rgba(255,255,255,.18),transparent);transform:rotate(25deg);animation:shine 2.6s infinite}
    @keyframes shine{0%{transform:translateX(-120%) rotate(25deg)}100%{transform:translateX(120%) rotate(25deg)}}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
    .fadein{animation:fade .5s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .glow{box-shadow:0 0 0 0 rgba(124,58,237,.35);animation:glow 2.8s ease-in-out infinite}
    @keyframes glow{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,.28)}50%{box-shadow:0 0 30px 6px rgba(124,58,237,.28)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo glow float"></div>
      <h1>‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á ‚Üí ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h1>
    </header>

    <!-- REGISTER -->
    <section id="registerCard" class="card fadein">
      <h3>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
      <div class="row">
        <div class="grow">
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <input id="regEmail" type="email" placeholder="you@example.com" />
          <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input id="regPass" type="password" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" />
          <label>‡∏ä‡∏∑‡πà‡∏≠ Xbox</label>
          <input id="regXbox" placeholder="‡πÄ‡∏ä‡πà‡∏ô SeaMuww" />
          <div class="row"><button id="btnRegister" class="shine">‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button><button id="toLogin" class="ghost">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="grow">
          <div class="muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</div>
          <ul class="muted" style="margin:6px 0 0 18px">
            <li>Firebase Auth (‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)</li>
            <li>‡∏ä‡∏∑‡πà‡∏≠ Xbox ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå + ‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô <code>users</code></li>
            <li>WebRTC ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏ö‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="loginCard" class="card hidden fadein">
      <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input id="logEmail" type="email" />
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <input id="logPass" type="password" />
      <div class="row"><button id="btnLogin" class="shine">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button><button id="toRegister" class="ghost">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button></div>
    </section>

    <!-- LOBBY -->
    <section id="lobbyCard" class="card hidden fadein">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="tag">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <strong id="helloName">‚Äî</strong></div>
        <button id="btnLogout" class="ghost">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="grow">
          <h3 style="margin:0 0 6px">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h3>
          <button id="btnCreate" class="shine">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤</button>
          <div id="createdBox" class="hidden" style="margin-top:10px">
            <div class="muted">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</div>
            <div class="bigcode" id="roomCode">‚Äî ‚Äî ‚Äî ‚Äî</div>
            <button id="btnCopy" class="ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
          </div>
        </div>
        <div class="grow">
          <h3 style="margin:0 0 6px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</h3>
          <label>‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (6 ‡∏´‡∏•‡∏±‡∏Å)</label>
          <input id="joinCode" maxlength="6" inputmode="numeric" placeholder="493120" />
          <div style="height:8px"></div>
          <button id="btnJoin" class="secondary shine">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
      </div>
    </section>

    <!-- IN-ROOM -->
    <section id="roomCard" class="card hidden fadein">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="tag">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: <strong id="roomLabel">‚Äî</strong></div>
        <div class="row">
          <button id="btnToggleMic" class="shine">üéôÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
          <button id="btnLeave" class="ghost">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="muted">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <div id="status" class="status">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>
      <audio id="remoteAudio" autoplay playsinline class="hidden"></audio>
    </section>

    <div class="muted" style="text-align:center;margin-top:8px">Make by Purple Shop ¬∑ Firebase Auth + Firestore Signaling ¬∑ WebRTC (Audio)</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
  'use strict';
  // ===== 0) CONFIG (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì, ‡πÅ‡∏Å‡πâ storageBucket ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å) =====
  const firebaseConfig = {
    apiKey: "AIzaSyBswfpiFSZaeHaEKT0RQcsTJMlgdqN8j2A",
    authDomain: "webxxx-c2c15.firebaseapp.com",
    databaseURL: "https://webxxx-c2c15-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "webxxx-c2c15",
    storageBucket: "webxxx-c2c15.appspot.com",
    messagingSenderId: "1067079003521",
    appId: "1:1067079003521:web:a3869d6f857e49fb490c80",
    measurementId: "G-7VGKRTCCSF"
  };

  // ===== 1) BOOT =====
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();
// ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ SDK ‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ offline (‡πÄ‡∏ä‡πà‡∏ô reload ‡∏´‡∏•‡∏±‡∏á disableNetwork)
db.enableNetwork().catch(()=>{});
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

  // ===== 2) helpers =====
  const $ = (s)=>document.querySelector(s);
  const show = (el,on=true)=>el.classList.toggle('hidden',!on);
  const copy = (t)=>navigator.clipboard?.writeText(t).catch(()=>{});
  const log = (m)=>{ const box=$('#status'); if(box){ box.textContent += "\n"+m; box.scrollTop = box.scrollHeight; } console.log(m); };
  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö');
  }

  // sections
  const registerCard = $('#registerCard');
  const loginCard    = $('#loginCard');
  const lobbyCard    = $('#lobbyCard');
  const roomCard     = $('#roomCard');

  // controls
  const helloName = $('#helloName');
  const btnRegister = $('#btnRegister');
  const btnLogin    = $('#btnLogin');
  const btnLogout   = $('#btnLogout');
  const toLogin     = $('#toLogin');
  const toRegister  = $('#toRegister');

  const btnCreate = $('#btnCreate');
  const btnJoin   = $('#btnJoin');
  const btnCopy   = $('#btnCopy');
  const joinCode  = $('#joinCode');

  const btnToggleMic = $('#btnToggleMic');
  const btnLeave     = $('#btnLeave');
  const roomLabel    = $('#roomLabel');
  const roomCodeEl   = $('#roomCode');

  const remoteAudioEl = $('#remoteAudio');

  // ===== 3) AUTH =====
  toLogin.onclick = ()=>{ show(registerCard,false); show(loginCard,true); };
  toRegister.onclick = ()=>{ show(loginCard,false); show(registerCard,true); };

  btnRegister.onclick = async ()=>{
    const email = $('#regEmail').value.trim();
    const pass  = $('#regPass').value.trim();
    const xbox  = $('#regXbox').value.trim();
    if(!email||!pass||!xbox) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    try{
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: xbox });
      await db.collection('users').doc(cred.user.uid).set({ email, xbox, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß');
    }catch(err){ alert(err.message); }
  };

  btnLogin.onclick = async ()=>{
    const email = $('#logEmail').value.trim();
    const pass  = $('#logPass').value.trim();
    if(!email||!pass) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
    try{ await auth.signInWithEmailAndPassword(email, pass); }catch(err){ alert(err.message); }
  };

  btnLogout.onclick = ()=> auth.signOut();

  auth.onAuthStateChanged((user)=>{
    if(user){
      helloName.textContent = user.displayName || user.email;
      show(registerCard,false); show(loginCard,false); show(lobbyCard,true); show(roomCard,false);
    }else{
      show(lobbyCard,false); show(roomCard,false); show(loginCard,true); show(registerCard,false);
    }
  });

  // ===== 4) WEBRTC =====
  const rtcConfig = { iceServers:[{ urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'] }], iceCandidatePoolSize:10 };
  let pc=null, localStream=null, remoteStream=null, roomRef=null;
  let unsubAnswer=null, unsubCaller=null, unsubCallee=null; let createdByMe=false, micOn=false;

  const randRoomCode = ()=> (Math.floor(100000+Math.random()*900000)).toString();

  const ensureMic = async ()=>{
    if(!localStream){
      try{ localStream = await navigator.mediaDevices.getUserMedia({ audio:true }); }
      catch(e){ alert('‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e.message); throw e; }
    }
    return localStream;
  };

  async function createPeer(){
    pc = new RTCPeerConnection(rtcConfig);
    remoteStream = new MediaStream();
    remoteAudioEl.srcObject = remoteStream;

    pc.ontrack = (ev)=>{ try{ ev.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t)); }catch{}; remoteAudioEl.classList.remove('hidden'); log('üì• ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤'); };
    pc.onconnectionstatechange = ()=> log('üîó ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: '+pc.connectionState);

    const s = await ensureMic();
    s.getAudioTracks().forEach(t=>{ t.enabled=false; pc.addTrack(t, s); });
  }

  async function createRoomAndJoin(){
    try{
      const code = randRoomCode();
      roomRef = db.collection('rooms').doc(code);
// ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ offline ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ throw
try {
  const exists = await roomRef.get();
  if (exists.exists) return createRoomAndJoin();
} catch (e) {
  console.warn('skip exists-check (offline?)', e);
}

      createdByMe = true; roomLabel.textContent=code; roomCodeEl.textContent=code; show($('#createdBox'),true);
      await createPeer();

      const callerCandidates = roomRef.collection('callerCandidates');
      pc.onicecandidate = (e)=>{ if(e.candidate) callerCandidates.add(e.candidate.toJSON()); };

      const offer = await pc.createOffer({ offerToReceiveAudio: 1 });
      await pc.setLocalDescription(offer);

      const profile = { uid:auth.currentUser.uid, name:auth.currentUser.displayName||auth.currentUser.email, ts:firebase.firestore.FieldValue.serverTimestamp() };
      await roomRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: profile, offer:{type:offer.type,sdp:offer.sdp}, members:[profile] });

      unsubAnswer = roomRef.onSnapshot(async (snap)=>{
        const data=snap.data();
        if(!pc.currentRemoteDescription && data && data.answer){ await pc.setRemoteDescription(new RTCSessionDescription(data.answer)); log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (answer)'); }
      });

      unsubCallee = roomRef.collection('calleeCandidates').onSnapshot((snap)=>{
        snap.docChanges().forEach((c)=>{ if(c.type==='added'){ pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); } });
      });

      show(lobbyCard,false); show(roomCard,true); log('üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‚Ä¶');
    }catch(err){ console.error(err); alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err.message||err)); }
  }

  async function joinRoomByCode(){
    try{
      const code = (joinCode.value||'').trim(); if(code.length!==6) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å');
      roomRef = db.collection('rooms').doc(code); const snap = await roomRef.get(); if(!snap.exists) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ');

      await createPeer();
      const calleeCandidates = roomRef.collection('calleeCandidates');
      pc.onicecandidate = (e)=>{ if(e.candidate) calleeCandidates.add(e.candidate.toJSON()); };

      const data = snap.data(); await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);

      const profile = { uid:auth.currentUser.uid, name:auth.currentUser.displayName||auth.currentUser.email, ts:firebase.firestore.FieldValue.serverTimestamp() };
      await roomRef.update({ answer:{type:answer.type,sdp:answer.sdp}, members: firebase.firestore.FieldValue.arrayUnion(profile) });

      unsubCaller = roomRef.collection('callerCandidates').onSnapshot((snap)=>{
        snap.docChanges().forEach((c)=>{ if(c.type==='added'){ pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); } });
      });

      roomLabel.textContent = code; show(lobbyCard,false); show(roomCard,true); log('üö™ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
    }catch(err){ console.error(err); alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err.message||err)); }
  }

  function setMic(on){ if(!localStream) return; localStream.getAudioTracks().forEach(t=> t.enabled = on); micOn = on; btnToggleMic.textContent = on?'üîá ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå':'üéôÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå'; log(on?'üéôÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå':'üîá ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå'); }

  async function leaveRoom(){
    try{
      setMic(false);
      if(pc){ pc.getSenders().forEach(s=>{ try{s.track&&s.track.stop();}catch{} }); pc.close(); }
      pc=null; if(unsubAnswer)unsubAnswer(); if(unsubCaller)unsubCaller(); if(unsubCallee)unsubCallee(); unsubAnswer=unsubCaller=unsubCallee=null;
      if(createdByMe && roomRef){ try{ await roomRef.delete(); }catch{} }
    } finally { show(roomCard,false); show(lobbyCard,true); log('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); }
  }

  // wire
  btnCreate.onclick = createRoomAndJoin;
  btnJoin.onclick   = joinRoomByCode;
  btnCopy.onclick   = ()=> copy(roomCodeEl.textContent);
  btnToggleMic.onclick = async ()=>{ if(!localStream){ try{ await ensureMic(); }catch{return;} } setMic(!micOn); };
  btnLeave.onclick  = leaveRoom;

  // init
  window.addEventListener('load', ()=>{ log('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ö‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost)'); });
  </script>
</body>
</html>
